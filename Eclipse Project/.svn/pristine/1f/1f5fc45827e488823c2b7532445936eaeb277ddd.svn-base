/*
 * CSE 593 - Fall 2016 - Applied Project
 * Author  : Lucio Ortiz and Robert Blazewicz
 * Version : DEVSJAVA 3.0
 * Date    : 2016-09-24
 */
package experiment.toolkit;

import java.io.BufferedReader;
import java.io.FileReader;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.ParseException;

import org.apache.commons.lang3.StringUtils;

/**
 * The Class ValueSetLoad.
 */
public class ValueSetLoad {

  /** The settings. */
  final Settings settings = SettingsSingleton.getInstance();

  /** The Constant defaultFilename. */
  private static final String defaultFilename = "ValueSet.properties";

  /** The pathname. */
  private String pathname;

  /** The filename. */
  private String filename;

  /**
   * Instantiates a new value set load.
   */
  public ValueSetLoad() {
    // Resolve path and file name for ValueSet data file.
    pathname = settings.lookupString("ValueSetPath", settings.getPathname());
    filename = settings.lookupString("ValueSetFile", defaultFilename);
  }

  /**
   * Load.
   *
   * @param valueSet the value set
   */
  public void load(final ValueSet valueSet) {
    loadValueSet(valueSet);
  }

  /**
   * Load.
   *
   * @param valueSet the value set
   * @param filename the filename
   */
  public void load(final ValueSet valueSet, final String filename) {
    this.filename = filename;
    loadValueSet(valueSet);
  }

  /**
   * Load.
   *
   * @param valueSet the value set
   * @param pathname the pathname
   * @param filename the filename
   */
  public void load(final ValueSet valueSet, final String pathname, final String filename) {
    this.pathname = pathname;
    this.filename = filename;
    loadValueSet(valueSet);
  }

  /**
   * Load value set.
   *
   * @param valueSet the value set
   */
  private void loadValueSet(final ValueSet valueSet) {
    final Path filePath = Paths.get(pathname, filename);
    try (FileReader fileReader = new FileReader(filePath.toFile())) {
      try (BufferedReader bufferedReader = new BufferedReader(fileReader)) {
        int lineNumber = 0;
        String line;
        while ((line = bufferedReader.readLine()) != null) {
          lineNumber++;
          if (line.isEmpty() || line.startsWith("#"))
            continue;
          line = StringUtils.strip(line);
          line = line.trim();
          if (line.isEmpty())
            continue;
          final String[] pair = line.split("=");
          if (pair.length == 2) {
            valueSet.addValue(pair[0].trim(), Double.parseDouble(pair[1].trim()));
          } else
            throw new ParseException("ValueSet file " + filePath + " line " + lineNumber + " has invalid format", 0);
        }
      }
    } catch (Exception e) {
      throw new RuntimeException(e.getMessage());
    }
  }

  /**
   * Gets the pathname.
   *
   * @return the pathname
   */
  public String getPathname() {
    return pathname;
  }

  /**
   * Gets the filename.
   *
   * @return the filename
   */
  public String getFilename() {
    return filename;
  }
}
