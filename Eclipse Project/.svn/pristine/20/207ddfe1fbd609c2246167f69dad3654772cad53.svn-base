/*
 * CSE 593 - Fall 2016 - Applied Project
 * Author  : Lucio Ortiz and Robert Blazewicz
 * Version : DEVSJAVA 3.0
 * Date    : 2016-08-31
 */
package turbojet.toolkit;

import java.io.FileReader;
import java.io.IOException;
import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Iterator;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import turbojet.toolkit.TypeMapping.theType;


/**
 * The Class Calibration.
 */
public class Calibration {

  private final Settings settings = SettingsSingleton.getInstance();

  private TypeMapping typeMapping;

  /** The Constant defaultPathname. */
  private static final String defaultPathname = ".";

  /** The Constant defaultFilename. */
  private static final String defaultFilename = "Calibration.json";

  /** The pathname. */
  private String pathname;

  /** The filename. */
  private String filename;

  /**
   * Instantiates a new calibration.
   *
   * @throws RuntimeException the runtime exception
   */
  public Calibration() throws RuntimeException {
    // Resolve path and file name for calibration data file.
    pathname = settings.lookupString("CalibrationPath", settings.getPathname());
    filename = settings.lookupString("CalibrationFile", defaultFilename);

    // Resolve path and file name for type mapping data file, and load type map.
    typeMapping = new TypeMapping();
    typeMapping.setPathname(settings.lookupString("TypeMappingPath", settings.getPathname()));
    typeMapping.setFilename(settings.lookupString("TypeMappingFile", typeMapping.getFilename()));
    typeMapping.parseFile();

    // Load calibration data
    JSONParser parser = new JSONParser();
    final Path filePath = Paths.get(pathname, filename);
    try (FileReader fileReader = new FileReader(filePath.toFile())) {
      final Object obj = parser.parse(fileReader);
      final JSONObject jsonObject = (JSONObject) obj;
      for (Object key : jsonObject.keySet()) {
        final String keyName = (String)key;

        final Object keyValue = jsonObject.get(keyName);
        if (keyValue instanceof JSONArray)
          System.out.println("Key: "+ keyName + " array unsupported - " + (JSONArray)keyValue);
        else if (keyValue instanceof JSONObject)
          System.out.println("Key: "+ keyName + " nested object unsupported - " + (JSONObject)keyValue);
        else
          System.out.println("Key: "+ keyName + " value: " + keyValue);
      }
    } catch (IOException | ParseException e) {
      throw new RuntimeException("TypeMapping file " + filePath + ": " + e.getMessage());
    }

    System.out.println("Calibration initialization complete");
  }

  /**
   * Gets the pathname.
   *
   * @return the pathname
   */
  public String getPathname() {
    return pathname;
  }

  /**
   * Gets the filename.
   *
   * @return the filename
   */
  public String getFilename() {
    return filename;
  }

  /**
   * Update.
   *
   * @param someClass the some class
   */
  public void update(Object someClass) {
    try {
      final Field[] fields = someClass.getClass().getDeclaredFields();

      for (int i = 0; i < fields.length; i++) {
        final Field field = fields[i];

        //System.out.println("  --"+field.getName());
        int modifiers = field.getModifiers();

        if (Modifier.isFinal(modifiers)) {
          //String str= field.getType().getTypeName();
          switch (field.getType().getTypeName()) {
            case "boolean":

              if (field.getName() == "KeABC_Bool_Test1") {
                System.out.println("boolean: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, false);
              }
              if (field.getName() == "KeABC_Bool_Test2") {
                System.out.println("boolean: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, false);
              }

              break;

            case "char":

              if (field.getName() == "KeABC_c_Test1") {
                System.out.println("char: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 'A');
              }
              if (field.getName() == "KeABC_c_Test2") {
                System.out.println("char: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 'Z');
              }

              break;

            case "int":

              if (field.getName() == "KeABC_Cnt_Test1") {
                System.out.println("int: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 1996);
              }
              if (field.getName() == "KeABC_Cnt_Test2") {
                System.out.println("int: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 1997);
              }

              break;

            case "double":

              if (field.getName() == "KeABC_d_Test1") {
                System.out.println("double: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 3.1415);
              }
              if (field.getName() == "KeABC_d_Test2") {
                System.out.println("double: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, 1.618);
              }

              break;

            case "java.lang.String":

              if (field.getName() == "KeABC_Str_Test1") {
                System.out.println("String: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, "First Test");
              }
              if (field.getName() == "KeABC_Str_Test2") {
                System.out.println("String: " + field.getName());
                field.setAccessible(true);
                field.set(someClass, "Second Test");
              }

              break;
          }
        }
      }
    } catch (SecurityException e) {
      // TODO Auto-generated catch block
      e.printStackTrace();
    } catch (Exception e) {
      // TODO Auto-generated catch block
      e.printStackTrace();
    }
  }
}
